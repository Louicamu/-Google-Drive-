# 🗑️ 回收站功能说明

## ✅ 已完整实现

回收站功能现在已经完全实现，包含以下所有功能：

---

## 🎯 核心功能

### 1️⃣ **删除文件到回收站**（软删除）

**操作方式**：
- 在文件列表中，点击文件的 "..." 菜单
- 选择"删除"
- 文件会被移动到回收站，而不是直接删除

**实现逻辑**：
```typescript
// 设置 isDeleted = true，保留文件数据
await FileItem.findByIdAndUpdate(id, {
  isDeleted: true,
  deletedAt: new Date(),
});
```

**特点**：
- ✅ 文件数据保留在数据库中
- ✅ 物理文件保留在服务器上
- ✅ 可以恢复

---

### 2️⃣ **查看回收站**

**访问路径**：
- 点击左侧导航栏的"回收站"
- 或访问：`/trash`

**显示内容**：
- 📄 文件名和图标
- 📊 文件大小
- ⏰ 删除时间
- 🎯 操作按钮（恢复 / 永久删除）

**界面特点**：
- 表格式布局，清晰易读
- 按删除时间倒序排序（最新删除的在前）
- 空回收站时显示友好提示

---

### 3️⃣ **恢复文件**

**操作方式**：
1. 进入回收站
2. 找到要恢复的文件
3. 点击"恢复"按钮
4. 确认恢复

**实现逻辑**：
```typescript
// 恢复文件，取消删除标记
await FileItem.findByIdAndUpdate(id, {
  isDeleted: false,
  deletedAt: undefined,
});
```

**效果**：
- ✅ 文件恢复到原位置
- ✅ 可以在"我的云盘"中看到
- ✅ 所有属性保持不变（星标、分享等）

---

### 4️⃣ **永久删除单个文件**

**操作方式**：
1. 进入回收站
2. 找到要删除的文件
3. 点击"永久删除"按钮
4. 确认删除（⚠️ 此操作无法撤销）

**实现逻辑**：
```typescript
// 删除物理文件
if (file.url) {
  await unlink(filePath);
}

// 从数据库永久删除
await FileItem.findByIdAndDelete(id);
```

**效果**：
- ❌ 文件数据从数据库删除
- ❌ 物理文件从服务器删除
- ❌ **无法恢复**

---

### 5️⃣ **清空回收站**

**操作方式**：
1. 进入回收站
2. 点击顶部"清空回收站"按钮
3. 确认清空（⚠️ 此操作无法撤销）

**实现逻辑**：
```typescript
// 批量删除所有已删除的文件
for (const file of deletedFiles) {
  // 删除物理文件
  if (file.url) await unlink(filePath);
  // 删除数据库记录
  await FileItem.findByIdAndDelete(file._id);
}
```

**效果**：
- ❌ 回收站中所有文件被永久删除
- ❌ 所有物理文件被删除
- ❌ **无法恢复**

---

## 🛠️ API 路由

### 获取回收站文件
```
GET /api/files?type=trash
```

### 恢复文件
```
POST /api/files/[id]/restore
```

### 永久删除文件
```
DELETE /api/files/[id]/permanent
```

### 清空回收站
```
DELETE /api/files/trash/empty
```

---

## 🧪 测试步骤

### 测试删除和恢复

1. **上传测试文件**：
   ```
   - 登录应用
   - 上传一个测试文件（如 test.txt）
   ```

2. **删除文件**：
   ```
   - 点击文件的 "..." 菜单
   - 选择"删除"
   - 确认文件消失
   ```

3. **查看回收站**：
   ```
   - 点击左侧"回收站"
   - 应该能看到刚才删除的文件
   - 显示删除时间
   ```

4. **恢复文件**：
   ```
   - 点击"恢复"按钮
   - 确认恢复
   - 返回"我的云盘"
   - 文件应该回来了
   ```

5. **永久删除**：
   ```
   - 再次删除文件
   - 进入回收站
   - 点击"永久删除"
   - 确认删除
   - 文件从回收站消失
   - 无法恢复
   ```

---

## 📊 数据库字段

**FileItem 模型**中相关字段：

```typescript
{
  isDeleted: Boolean,    // 是否已删除
  deletedAt: Date,       // 删除时间
}
```

**查询已删除文件**：
```javascript
FileItem.find({
  ownerId: userId,
  isDeleted: true,
})
```

**查询正常文件**：
```javascript
FileItem.find({
  ownerId: userId,
  isDeleted: false,
})
```

---

## 🎨 界面展示

### 回收站为空时
```
🗑️
回收站为空
删除的文件将在 30 天后永久删除
```

### 有文件时
```
┌─────────────────────────────────────────────────────────┐
│ 回收站                            [清空回收站] 按钮      │
├─────────────────────────────────────────────────────────┤
│ 名称        │ 大小    │ 删除时间           │ 操作      │
├─────────────────────────────────────────────────────────┤
│ 📄 test.pdf │ 1.2 MB  │ 2025-10-03 14:30  │ 恢复|永久删除│
│ 📁 图片      │ -       │ 2025-10-03 14:25  │ 恢复|永久删除│
│ 📄 doc.docx │ 500 KB  │ 2025-10-03 14:20  │ 恢复|永久删除│
└─────────────────────────────────────────────────────────┘
```

---

## ⚠️ 注意事项

### 安全提示

1. **永久删除前确认**：
   - 永久删除的文件无法恢复
   - 请仔细确认后再操作

2. **清空回收站前确认**：
   - 会删除所有回收站中的文件
   - 此操作影响范围大，请谨慎

3. **30天自动清理**（待实现）：
   - 建议添加定时任务
   - 自动清理超过30天的文件

---

## 🔮 未来优化

### 可选功能

1. **自动清理**：
   - 添加定时任务
   - 自动删除30天前的文件

2. **批量操作**：
   - 多选文件
   - 批量恢复
   - 批量永久删除

3. **搜索功能**：
   - 在回收站中搜索
   - 按文件名、类型筛选

4. **回收站容量统计**：
   - 显示回收站占用空间
   - 显示文件数量

5. **恢复到指定位置**：
   - 恢复时选择目标文件夹
   - 而不是恢复到原位置

---

## 🐛 故障排查

### 问题1：删除的文件看不到

**检查**：
1. 确认文件已标记为删除：
   ```javascript
   // 在 MongoDB 中查询
   db.fileitems.find({ isDeleted: true })
   ```

2. 检查 API 是否正确调用：
   ```javascript
   // 浏览器控制台
   fetch('/api/files?type=trash')
   ```

3. 查看服务器日志

### 问题2：恢复失败

**检查**：
1. 文件是否存在且属于当前用户
2. 文件是否已标记为删除
3. 查看服务器日志中的错误信息

### 问题3：永久删除后物理文件仍存在

**原因**：
- 只有本地上传的文件才会删除物理文件
- Vercel Blob 上传的文件需要调用 Blob API 删除

**解决**：
- 本地环境：检查 public/uploads 目录
- Vercel 环境：需要额外实现 Blob 删除逻辑

---

## ✅ 功能清单

- [x] 软删除文件（移到回收站）
- [x] 显示回收站中的文件
- [x] 恢复单个文件
- [x] 永久删除单个文件
- [x] 清空回收站
- [x] 删除物理文件
- [x] 显示删除时间
- [x] 友好的用户提示
- [ ] 自动清理（30天）
- [ ] 批量操作
- [ ] 搜索功能

---

**版本**：v1.0  
**更新时间**：2025-10-03  
**状态**：✅ 核心功能已完成

