# 🔗 分享功能调试指南

## ✅ 已修复的问题

### 1. 分享链接域名问题
**问题**：分享链接使用的是环境变量 `NEXTAUTH_URL`，可能与实际访问域名不一致

**修复**：现在自动使用实际的请求域名生成分享链接
- 本地：`http://localhost:3000/share/xxx`
- Vercel：`https://你的项目.vercel.app/share/xxx`

### 2. 增强错误日志
添加了详细的控制台日志，方便排查问题

---

## 🧪 测试分享功能

### 测试步骤：

#### 1️⃣ **创建分享链接**
```
1. 登录到应用
2. 上传一个文件（如图片或PDF）
3. 点击文件的"..." 菜单
4. 选择"分享"
5. 配置分享选项：
   - 权限：仅查看/可编辑
   - 过期时间：永不过期/1小时/1天/7天/30天
   - 密码保护：可选
6. 点击"创建分享链接"
7. 复制生成的链接
```

#### 2️⃣ **测试访问（本地）**
```
1. 在隐私/无痕窗口打开复制的链接
2. 如果设置了密码，输入密码
3. 应该能看到文件信息和预览
4. 点击"下载文件"测试下载
```

#### 3️⃣ **测试访问（部署后）**
```
1. 部署到 Vercel
2. 创建分享链接
3. 发送给朋友或在其他设备测试
4. 确认能正常访问
```

---

## 🐛 常见问题排查

### 问题1：分享链接打不开（404错误）

**可能原因**：
- ❌ 链接生成时使用了错误的域名
- ❌ 数据库中没有该分享记录
- ❌ 文件已被删除

**排查步骤**：
1. **检查链接格式**：
   ```
   正确：https://你的域名/share/32位十六进制字符
   错误：https://你的域名/share/ (缺少token)
   ```

2. **查看服务器日志**（Vercel Dashboard → Runtime Logs）：
   ```
   应该看到：
   🔗 访问分享链接: { token: 'xxx...', hasPassword: false }
   ✅ 找到文件: { name: 'xxx.pdf', ... }
   ```

3. **检查数据库**：
   - 使用 MongoDB Compass 连接数据库
   - 查看 `fileitems` 集合
   - 确认文件有 `sharedLink.token` 字段

### 问题2：显示"分享链接不存在或已失效"

**可能原因**：
- ❌ 分享已被删除
- ❌ 文件已被移到回收站
- ❌ Token 不匹配

**解决方法**：
1. 重新创建分享链接
2. 确认文件没有被删除
3. 检查复制的链接是否完整

### 问题3：密码保护不工作

**可能原因**：
- ❌ 密码未正确保存
- ❌ 密码比较失败

**解决方法**：
1. 查看服务器日志中的密码验证信息
2. 重新创建分享并设置新密码
3. 确认输入的密码完全一致（区分大小写）

### 问题4：分享链接已过期

**可能原因**：
- ⏰ 设置了过期时间且已到期

**解决方法**：
1. 重新创建分享链接
2. 选择更长的过期时间或"永不过期"

---

## 📋 调试清单

### 本地测试：

- [ ] 能成功创建分享链接
- [ ] 复制的链接格式正确（包含完整的token）
- [ ] 在隐私窗口能打开分享页面
- [ ] 文件信息正确显示
- [ ] 密码保护正常工作
- [ ] 下载功能正常

### Vercel 部署测试：

- [ ] 环境变量已配置（MONGODB_URI, NEXTAUTH_URL, NEXTAUTH_SECRET）
- [ ] 能创建分享链接
- [ ] 生成的链接使用了正确的 Vercel 域名
- [ ] 其他人能访问分享链接（不需要登录）
- [ ] 密码保护正常工作
- [ ] 文件能正常下载

---

## 🔍 查看详细日志

### 本地开发：
```powershell
# 启动开发服务器
npm run dev

# 查看终端输出的日志
# 访问分享链接时会显示：
# 🔗 访问分享链接: { token: '...', hasPassword: ... }
# ✅ 找到文件: { name: '...', ... }
```

### Vercel 部署：
```
1. 访问 Vercel Dashboard
2. 选择你的项目
3. 点击 "Runtime Logs" 或 "Logs"
4. 访问分享链接
5. 查看实时日志输出
```

---

## 🛠️ 手动测试分享功能

### 使用 curl 测试：

```bash
# 1. 创建分享（需要登录token）
curl -X POST https://你的域名/api/files/文件ID/share \
  -H "Content-Type: application/json" \
  -d '{
    "permission": "view",
    "password": "test123"
  }'

# 2. 访问分享（无需登录）
curl https://你的域名/api/share/生成的token

# 3. 带密码访问
curl "https://你的域名/api/share/生成的token?password=test123"
```

---

## ✅ 成功标志

当分享功能正常工作时，你应该看到：

1. **创建分享时**：
   - ✅ 弹窗显示分享链接
   - ✅ 链接格式：`https://域名/share/32位字符`
   - ✅ 可以复制链接

2. **访问分享时**：
   - ✅ 无需登录就能访问
   - ✅ 显示文件信息（名称、大小、类型等）
   - ✅ 图片文件有预览
   - ✅ 可以下载文件

3. **服务器日志**：
   ```
   🔗 访问分享链接
   ✅ 找到文件
   ✅ 返回文件信息
   ```

---

## 🆘 仍然无法解决？

请提供以下信息：

1. **环境**：本地开发 / Vercel 部署
2. **错误信息**：浏览器控制台的完整错误
3. **服务器日志**：Vercel Logs 或本地终端的输出
4. **分享链接示例**：`https://xxx.vercel.app/share/abc123...`
5. **复现步骤**：详细描述如何触发问题

我会根据这些信息帮你进一步排查！

---

**更新时间**：2025-10-03  
**版本**：v1.1 - 修复分享链接域名问题

